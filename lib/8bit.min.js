/*! 8bit - v0.1.0 - 2013-08-25 */
!function(){function a(){function a(){v+=p.currentTime-m,m=p.currentTime}function g(a){return 10*(c[a]*l/k)}function h(){u.forEach(function(a){a.o.stop(0)}),o.end()}function i(a,b){if("up"!==a&&"down"!==a)throw new Error("Direction must be either up or down.");var c=100*s,d=function(){setTimeout(function(){if(c>0){c-=2,c=0>c?0:c;var e="up"===a?100*s-c:c;r.gain.value=e/100,d()}else"function"==typeof b&&b()},1)};d()}var j,k,l,m,n,o=this,p=new(window.AudioContext||window.webkitAudioContext),q=p.createGain(),r=p.createGain(),s=1,t=[],u=[],v=0,w=0,x=!1,y=!1,z=!1,A=function(a){o.stop(!1),z?o.play():"function"==typeof a&&a()},B=function(){setTimeout(function(){!x&&y&&(v>w?A(n):(a(),B()))},1)},C=function(){function a(a){if(a){if("undefined"==typeof f[a])throw new Error(a+" is not a valid Waveform.")}else a="sine";var e=this,h=0,i=0,j=.25,k=f[a],l=[];this.setVolume=function(a){return j=a/100,e},this.note=function(a,b,f){if("undefined"==typeof c[b])throw new Error(b+" is not a correct note.");var i=g(b),j=f?0:.1*i,m=a.split(",");return m.forEach(function(a){if(a=a.trim(),"undefined"==typeof d[a])throw new Error(a+" is not a valid pitch.")}),l.push({pitch:a,pitchType:k,duration:i,articulationGap:j,startTime:h,stopTime:h+i-j}),h+=i,e},this.rest=function(a){if("undefined"==typeof c[a])throw new Error("Need to use correct note.");var b=g(a);return l.push({pitch:!1,pitchType:0,duration:b,articulationGap:0,startTime:h,stopTime:h+b}),h+=b,e},this.repeatStart=function(){return i=l.length,e},this.repeatFromBeginning=function(a){return i=0,e.repeat(a),e},this.repeat=function(a){a="undefined"==typeof a?1:a;for(var c=0;a>c;c++){var d=l.slice(i);i=d.length,d.forEach(function(a){var c=b(a);c.startTime=h,c.stopTime=h+c.duration-c.articulationGap,l.push(c),h+=c.duration})}return e},this.finish=function(){var a=0;l.forEach(function(b){a+=b.duration}),t.push({notes:l,totalDuration:a,volumeLevel:j})}}return a}();q.gain.value=0,q.connect(p.destination),r.gain.value=1,r.connect(p.destination),this.load=function(a){if(!a)throw new Error("JSON is required for this method to work.");if("undefined"==typeof a.instruments)throw new Error("You must define at least one instrument");if("undefined"==typeof a.notes)throw new Error("You must define notes for each instrument");"undefined"!=typeof a.timeSignature&&o.setTimeSignature(a.timeSignature[0],a.timeSignature[1]),"undefined"!=typeof a.tempo&&o.setTempo(a.tempo);var b={};for(var c in a.instruments)a.instruments.hasOwnProperty(c)&&(b[c]=o.createInstrument(a.instruments[c]));for(var d in a.notes)a.notes.hasOwnProperty(d)&&(a.notes[d].forEach(function(a){"string"==typeof a?(a=a.split("|"),"rest"===a[0]?b[d].rest(a[1]):b[d].note(a[0],a[1],a[2])):"rest"===a.type?b[d].rest(a.rhythm):"note"===a.type&&b[d].note(a.pitch,a.rhythm,a.tie)}),b[d].finish());o.end()},this.createInstrument=function(a){return new C(a)},this.stop=function(a){y=!1,"undefined"==typeof a&&(a=!0),a?i("down",function(){v=0,h(),o.unmute()}):(v=0,h())},this.setMasterVolume=function(a){s=a,r.gain.value=s},this.mute=function(a){i("down",a)},this.unmute=function(a){i("up",a)},this.end=function(){u=[],w=0;for(var a=0;a<t.length;a++){w<t[a].totalDuration&&(w=t[a].totalDuration);var b=t[a].notes,c=p.createGain();c.connect(r),c.gain.value=t[a].volumeLevel;for(var e=0;e<b.length;e++){var f=b[e].pitch,g=b[e].startTime,h=b[e].stopTime,i=b[e].pitchType;f&&f.split(",").forEach(function(a){a=a.trim();var b=p.createOscillator();b.connect(c),b.type=i,b.frequency.value=d[a],u.push({startTime:g,stopTime:h,o:b})})}}},this.setTimeSignature=function(a,b){if("undefined"==typeof e[b])throw new Error("The bottom time signature is not supported.");j=a,k=e[b]},this.setTempo=function(a){l=60/a},this.play=function(){y=!0,x=!1,m=p.currentTime,B();var a=p.currentTime-v;u.forEach(function(b){var c=b.o,d=b.startTime+a,e=b.stopTime+a;c.start(d),c.stop(e)}),v>0&&i("up")},this.onFinished=function(a){if("function"!=typeof a)throw new Error("onFinished callback must be a function.");n=a},this.pause=function(){x=!0,a(),i("down",function(){h()})},this.loop=function(a){z=a},this.setTempo(120),this.setTimeSignature(4,4)}function b(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var c={whole:1,dottedHalf:.75,half:.5,dottedQuarter:.375,tripletHalf:.33333334,quarter:.25,dottedEighth:.1875,tripletQuarter:.166666667,eighth:.125,dottedSixteenth:.09375,tripletEighth:.083333333,sixteenth:.0625,tripletSixteenth:.041666667,thirtySecond:.03125},d={C0:16.35,"C#0":17.32,Db0:17.32,D0:18.35,"D#0":19.45,Eb0:19.45,E0:20.6,F0:21.83,"F#0":23.12,Gb0:23.12,G0:24.5,"G#0":25.96,Ab0:25.96,A0:27.5,"A#0":29.14,Bb0:29.14,B0:30.87,C1:32.7,"C#1":34.65,Db1:34.65,D1:36.71,"D#1":38.89,Eb1:38.89,E1:41.2,F1:43.65,"F#1":46.25,Gb1:46.25,G1:49,"G#1":51.91,Ab1:51.91,A1:55,"A#1":58.27,Bb1:58.27,B1:61.74,C2:65.41,"C#2":69.3,Db2:69.3,D2:73.42,"D#2":77.78,Eb2:77.78,E2:82.41,F2:87.31,"F#2":92.5,Gb2:92.5,G2:98,"G#2":103.83,Ab2:103.83,A2:110,"A#2":116.54,Bb2:116.54,B2:123.47,C3:130.81,"C#3":138.59,Db3:138.59,D3:146.83,"D#3":155.56,Eb3:155.56,E3:164.81,F3:174.61,"F#3":185,Gb3:185,G3:196,"G#3":207.65,Ab3:207.65,A3:220,"A#3":233.08,Bb3:233.08,B3:246.94,C4:261.63,"C#4":277.18,Db4:277.18,D4:293.66,"D#4":311.13,Eb4:311.13,E4:329.63,F4:349.23,"F#4":369.99,Gb4:369.99,G4:392,"G#4":415.3,Ab4:415.3,A4:440,"A#4":466.16,Bb4:466.16,B4:493.88,C5:523.25,"C#5":554.37,Db5:554.37,D5:587.33,"D#5":622.25,Eb5:622.25,E5:659.26,F5:698.46,"F#5":739.99,Gb5:739.99,G5:783.99,"G#5":830.61,Ab5:830.61,A5:880,"A#5":932.33,Bb5:932.33,B5:987.77,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,E6:1318.51,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,C8:4186.01},e={2:6,4:3,8:4.5},f={sine:0,square:1,sawtooth:2,triangle:3};"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):this.EightBit=a}.call(function(){return this||("undefined"!=typeof window?window:global)}());